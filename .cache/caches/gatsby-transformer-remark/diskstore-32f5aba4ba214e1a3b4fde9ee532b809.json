{"expireTime":9007200860997567000,"key":"transformer-remark-markdown-html-ast-30fb8cec1c4527472387654d185e5ab9-gatsby-remark-graphgatsby-remark-prismjsgatsby-remark-katex-","val":{"type":"root","children":[{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Recipe: Database as Code with Flyway & MySQL on Cloud Foundry","position":{"start":{"line":2,"column":3,"offset":3},"end":{"line":2,"column":64,"offset":64}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":64,"offset":64}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This recipe is illustrated in the ","position":{"start":{"line":4,"column":1,"offset":66},"end":{"line":4,"column":35,"offset":100}}},{"type":"element","tagName":"a","properties":{"href":"https://github.com/jamestharpe/pal-tracker"},"children":[{"type":"text","value":"PAL Tracker","position":{"start":{"line":4,"column":36,"offset":101},"end":{"line":4,"column":47,"offset":112}}}],"position":{"start":{"line":4,"column":35,"offset":100},"end":{"line":4,"column":92,"offset":157}}},{"type":"text","value":" example project.","position":{"start":{"line":4,"column":92,"offset":157},"end":{"line":4,"column":109,"offset":174}}}],"position":{"start":{"line":4,"column":1,"offset":66},"end":{"line":4,"column":109,"offset":174}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"1. Provision and Bind MySQL in Cloud Foundry","position":{"start":{"line":6,"column":4,"offset":179},"end":{"line":6,"column":48,"offset":223}}}],"position":{"start":{"line":6,"column":1,"offset":176},"end":{"line":6,"column":48,"offset":223}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Use ","position":{"start":{"line":8,"column":1,"offset":225},"end":{"line":8,"column":5,"offset":229}}},{"type":"raw","value":"<code class=\"language-text\">cf marketplace</code>","position":{"start":{"line":8,"column":5,"offset":229},"end":{"line":8,"column":21,"offset":245}}},{"type":"text","value":" to find the appropriate service and provisioning options for MySQL, then use ","position":{"start":{"line":8,"column":21,"offset":245},"end":{"line":8,"column":99,"offset":323}}},{"type":"raw","value":"<code class=\"language-text\">cf create-service</code>","position":{"start":{"line":8,"column":99,"offset":323},"end":{"line":8,"column":118,"offset":342}}},{"type":"text","value":" to provision the service:","position":{"start":{"line":8,"column":118,"offset":342},"end":{"line":8,"column":144,"offset":368}}}],"position":{"start":{"line":8,"column":1,"offset":225},"end":{"line":8,"column":144,"offset":368}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cf marketplace\nGetting services from marketplace <span class=\"token keyword\">in</span> org some-org / space develop as you@example.com<span class=\"token punctuation\">..</span>.\nOK\n\n<span class=\"token function\">service</span>               plans                  description\n<span class=\"token comment\"># ...</span>\np-mysql               100mb, 1gb             A DBaaS\n<span class=\"token comment\"># ...</span></code></pre></div>","position":{"start":{"line":10,"column":1,"offset":370},"end":{"line":19,"column":4,"offset":612}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the example above, the ","position":{"start":{"line":21,"column":1,"offset":614},"end":{"line":21,"column":27,"offset":640}}},{"type":"raw","value":"<code class=\"language-text\">p-mysql</code>","position":{"start":{"line":21,"column":27,"offset":640},"end":{"line":21,"column":36,"offset":649}}},{"type":"text","value":" service is available. Provision it with ","position":{"start":{"line":21,"column":36,"offset":649},"end":{"line":21,"column":77,"offset":690}}},{"type":"raw","value":"<code class=\"language-text\">cf create-service</code>","position":{"start":{"line":21,"column":77,"offset":690},"end":{"line":21,"column":96,"offset":709}}},{"type":"text","value":":","position":{"start":{"line":21,"column":96,"offset":709},"end":{"line":21,"column":97,"offset":710}}}],"position":{"start":{"line":21,"column":1,"offset":614},"end":{"line":21,"column":97,"offset":710}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf create-service p-mysql 100mb pal-tracker-db</code></pre></div>","position":{"start":{"line":23,"column":1,"offset":712},"end":{"line":25,"column":4,"offset":770}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The ","position":{"start":{"line":27,"column":1,"offset":772},"end":{"line":27,"column":5,"offset":776}}},{"type":"raw","value":"<code class=\"language-text\">cf create-service</code>","position":{"start":{"line":27,"column":5,"offset":776},"end":{"line":27,"column":24,"offset":795}}},{"type":"text","value":" call will return immediately, before the service is provisioned. To check the status use ","position":{"start":{"line":27,"column":24,"offset":795},"end":{"line":27,"column":114,"offset":885}}},{"type":"raw","value":"<code class=\"language-text\">cf service</code>","position":{"start":{"line":27,"column":114,"offset":885},"end":{"line":27,"column":126,"offset":897}}},{"type":"text","value":":","position":{"start":{"line":27,"column":126,"offset":897},"end":{"line":27,"column":127,"offset":898}}}],"position":{"start":{"line":27,"column":1,"offset":772},"end":{"line":27,"column":127,"offset":898}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cf <span class=\"token function\">service</span> pal-tracker-db\n\nService instance: pal-tracker-db\nService: p-mysql\nPlan: 100mb\nDescription: MySQL databases on demand\nDocumentation url:\nDashboard: https://p-mysql.example.com/manage/instances/abcd-ef12-3456\n\nLast Operation\nStatus: create succeeded\nMessage:\nStarted: <span class=\"token number\">2019</span>-01-15T22:59:07Z\nUpdated: <span class=\"token number\">2019</span>-01-15T22:59:26Z</code></pre></div>","position":{"start":{"line":29,"column":1,"offset":900},"end":{"line":44,"column":4,"offset":1241}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Once the service is ready, bind it to the ","position":{"start":{"line":46,"column":1,"offset":1243},"end":{"line":46,"column":43,"offset":1285}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"pal-tracker","position":{"start":{"line":46,"column":45,"offset":1287},"end":{"line":46,"column":56,"offset":1298}}}],"position":{"start":{"line":46,"column":43,"offset":1285},"end":{"line":46,"column":58,"offset":1300}}},{"type":"text","value":" application:","position":{"start":{"line":46,"column":58,"offset":1300},"end":{"line":46,"column":71,"offset":1313}}}],"position":{"start":{"line":46,"column":1,"offset":1243},"end":{"line":46,"column":71,"offset":1313}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf bind-service pal-tracker pal-tracker-db <span class=\"token comment\"># Service info added to VCAP_SERVICES env var</span></code></pre></div>","position":{"start":{"line":48,"column":1,"offset":1315},"end":{"line":50,"column":4,"offset":1415}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Once the service is bound, the ","position":{"start":{"line":52,"column":1,"offset":1417},"end":{"line":52,"column":32,"offset":1448}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"VCAP_SERVICES","position":{"start":{"line":52,"column":34,"offset":1450},"end":{"line":52,"column":47,"offset":1463}}}],"position":{"start":{"line":52,"column":32,"offset":1448},"end":{"line":52,"column":49,"offset":1465}}},{"type":"text","value":" environment variable will contain details about the service:","position":{"start":{"line":52,"column":49,"offset":1465},"end":{"line":52,"column":110,"offset":1526}}}],"position":{"start":{"line":52,"column":1,"offset":1417},"end":{"line":52,"column":110,"offset":1526}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cf <span class=\"token function\">env</span> my-app\nGetting <span class=\"token function\">env</span> variables <span class=\"token keyword\">for</span> app pal-tracker <span class=\"token keyword\">in</span> org some-org / space some-space as\nyou<span class=\"token punctuation\">..</span>.\nOK\nSystem-Provided:\n\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token string\">\"VCAP_SERVICES\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token string\">\"p.mysql\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token string\">\"label\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"p.mysql\"</span>,\n\t\t\t<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pal-tracker-db\"</span>,\n\t\t\t<span class=\"token string\">\"plan\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"db-small\"</span>,\n\t\t\t<span class=\"token string\">\"provider\"</span><span class=\"token builtin class-name\">:</span> null,\n\t\t\t<span class=\"token string\">\"syslog_drain_url\"</span><span class=\"token builtin class-name\">:</span> null,\n\t\t\t<span class=\"token string\">\"tags\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mysql\"</span> <span class=\"token punctuation\">]</span>,\n\t\t\t<span class=\"token string\">\"credentials\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token string\">\"hostname\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10.0.0.20\"</span>,\n\t\t\t<span class=\"token string\">\"jdbcUrl\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"jdbc:mysql://10.0.0.20:3306/service_instance_db?user=fefcbe8360854a18a7994b870e7b0bf5<span class=\"token entity\" title=\"\\u0026\">\\u0026</span>password=z9z6eskdbs1rhtxt\"</span>,\n\t\t\t<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"service_instance_db\"</span>,\n\t\t\t<span class=\"token string\">\"password\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"z9z6eskdbs1rhtxt\"</span>,\n\t\t\t<span class=\"token string\">\"port\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">3306</span>,\n\t\t\t<span class=\"token string\">\"uri\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"mysql://fefcbe8360854a18a7994b870e7b0bf5:z9z6eskdbs1rhtxt@10.0.0.20:3306/service_instance_db?reconnect=true\"</span>,\n\t\t\t<span class=\"token string\">\"username\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"fefcbe8360854a18a7994b870e7b0bf5\"</span>\n\t\t\t<span class=\"token punctuation\">}</span>,\n\t\t\t<span class=\"token string\">\"volume_mounts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":54,"column":1,"offset":1528},"end":{"line":84,"column":4,"offset":2332}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"2. Add the Database \"as code\" to the Project","position":{"start":{"line":86,"column":4,"offset":2337},"end":{"line":86,"column":48,"offset":2381}}}],"position":{"start":{"line":86,"column":1,"offset":2334},"end":{"line":86,"column":48,"offset":2381}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Create a ","position":{"start":{"line":88,"column":1,"offset":2383},"end":{"line":88,"column":10,"offset":2392}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"databases/tracker","position":{"start":{"line":88,"column":12,"offset":2394},"end":{"line":88,"column":29,"offset":2411}}}],"position":{"start":{"line":88,"column":10,"offset":2392},"end":{"line":88,"column":31,"offset":2413}}},{"type":"text","value":" folder in the application root then create a file called ","position":{"start":{"line":88,"column":31,"offset":2413},"end":{"line":88,"column":89,"offset":2471}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"create_databases.sql","position":{"start":{"line":88,"column":91,"offset":2473},"end":{"line":88,"column":111,"offset":2493}}}],"position":{"start":{"line":88,"column":89,"offset":2471},"end":{"line":88,"column":113,"offset":2495}}},{"type":"text","value":" there:","position":{"start":{"line":88,"column":113,"offset":2495},"end":{"line":88,"column":120,"offset":2502}}}],"position":{"start":{"line":88,"column":1,"offset":2383},"end":{"line":88,"column":120,"offset":2502}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> -p database/tracker\n<span class=\"token function\">touch</span> database/tracker/create_databases.sql</code></pre></div>","position":{"start":{"line":90,"column":1,"offset":2504},"end":{"line":93,"column":4,"offset":2585}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Edit the ","position":{"start":{"line":95,"column":1,"offset":2587},"end":{"line":95,"column":10,"offset":2596}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"create_databases.sql","position":{"start":{"line":95,"column":12,"offset":2598},"end":{"line":95,"column":32,"offset":2618}}}],"position":{"start":{"line":95,"column":10,"offset":2596},"end":{"line":95,"column":34,"offset":2620}}},{"type":"text","value":" file to create ","position":{"start":{"line":95,"column":34,"offset":2620},"end":{"line":95,"column":50,"offset":2636}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"tracker_dev","position":{"start":{"line":95,"column":52,"offset":2638},"end":{"line":95,"column":63,"offset":2649}}}],"position":{"start":{"line":95,"column":50,"offset":2636},"end":{"line":95,"column":65,"offset":2651}}},{"type":"text","value":" and ","position":{"start":{"line":95,"column":65,"offset":2651},"end":{"line":95,"column":70,"offset":2656}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"tracker_test","position":{"start":{"line":95,"column":72,"offset":2658},"end":{"line":95,"column":84,"offset":2670}}}],"position":{"start":{"line":95,"column":70,"offset":2656},"end":{"line":95,"column":86,"offset":2672}}},{"type":"text","value":" databases:","position":{"start":{"line":95,"column":86,"offset":2672},"end":{"line":95,"column":97,"offset":2683}}}],"position":{"start":{"line":95,"column":1,"offset":2587},"end":{"line":95,"column":97,"offset":2683}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Delete DBs if they exist</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">DATABASE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> tracker_dev<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">DATABASE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> tracker_test<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Create the databases</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> tracker_dev<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> tracker_test<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Add a user with full access to both DBs</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> <span class=\"token string\">'tracker'</span><span class=\"token variable\">@'localhost'</span>\n  IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token keyword\">ON</span> tracker_dev<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'tracker'</span> <span class=\"token variable\">@'localhost'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token keyword\">ON</span> tracker_test<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'tracker'</span> <span class=\"token variable\">@'localhost'</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":97,"column":1,"offset":2685},"end":{"line":111,"column":4,"offset":3125}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Add the first Migration","position":{"start":{"line":113,"column":5,"offset":3131},"end":{"line":113,"column":28,"offset":3154}}}],"position":{"start":{"line":113,"column":1,"offset":3127},"end":{"line":113,"column":28,"offset":3154}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Add a file called ","position":{"start":{"line":115,"column":1,"offset":3156},"end":{"line":115,"column":19,"offset":3174}}},{"type":"raw","value":"<code class=\"language-text\">V1__initial_schema.sql</code>","position":{"start":{"line":115,"column":19,"offset":3174},"end":{"line":115,"column":43,"offset":3198}}},{"type":"text","value":" to a folder called ","position":{"start":{"line":115,"column":43,"offset":3198},"end":{"line":115,"column":63,"offset":3218}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"migrations","position":{"start":{"line":115,"column":65,"offset":3220},"end":{"line":115,"column":75,"offset":3230}}}],"position":{"start":{"line":115,"column":63,"offset":3218},"end":{"line":115,"column":77,"offset":3232}}},{"type":"text","value":" in the ","position":{"start":{"line":115,"column":77,"offset":3232},"end":{"line":115,"column":85,"offset":3240}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"database/tracker","position":{"start":{"line":115,"column":87,"offset":3242},"end":{"line":115,"column":103,"offset":3258}}}],"position":{"start":{"line":115,"column":85,"offset":3240},"end":{"line":115,"column":105,"offset":3260}}},{"type":"text","value":" folder, then add a ","position":{"start":{"line":115,"column":105,"offset":3260},"end":{"line":115,"column":125,"offset":3280}}},{"type":"raw","value":"<code class=\"language-text\">CREATE TABLE</code>","position":{"start":{"line":115,"column":125,"offset":3280},"end":{"line":115,"column":139,"offset":3294}}},{"type":"text","value":" statement to store ","position":{"start":{"line":115,"column":139,"offset":3294},"end":{"line":115,"column":159,"offset":3314}}},{"type":"raw","value":"<code class=\"language-text\">TimeEntry</code>","position":{"start":{"line":115,"column":159,"offset":3314},"end":{"line":115,"column":170,"offset":3325}}},{"type":"text","value":" objects.","position":{"start":{"line":115,"column":170,"offset":3325},"end":{"line":115,"column":179,"offset":3334}}}],"position":{"start":{"line":115,"column":1,"offset":3156},"end":{"line":115,"column":179,"offset":3334}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> time_entries <span class=\"token punctuation\">(</span>\n  id         <span class=\"token keyword\">BIGINT</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  project_id <span class=\"token keyword\">BIGINT</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- projectId on TimeEntry</span>\n  user_id    <span class=\"token keyword\">BIGINT</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- userId on TimeEntry</span>\n  <span class=\"token keyword\">date</span>       <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">,</span>\n  hours      <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">ENGINE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">innodb</span>\n  <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span> <span class=\"token operator\">=</span> utf8<span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":117,"column":1,"offset":3336},"end":{"line":129,"column":4,"offset":3625}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"3. Create and Migrate a Local MySQL Databases","position":{"start":{"line":131,"column":4,"offset":3630},"end":{"line":131,"column":49,"offset":3675}}}],"position":{"start":{"line":131,"column":1,"offset":3627},"end":{"line":131,"column":49,"offset":3675}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To create the test and development databases, simply pass the ","position":{"start":{"line":133,"column":1,"offset":3677},"end":{"line":133,"column":63,"offset":3739}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"create_databases.sql","position":{"start":{"line":133,"column":65,"offset":3741},"end":{"line":133,"column":85,"offset":3761}}}],"position":{"start":{"line":133,"column":63,"offset":3739},"end":{"line":133,"column":87,"offset":3763}}},{"type":"text","value":" file to MySQL on the command line:","position":{"start":{"line":133,"column":87,"offset":3763},"end":{"line":133,"column":122,"offset":3798}}}],"position":{"start":{"line":133,"column":1,"offset":3677},"end":{"line":133,"column":122,"offset":3798}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql -uroot <span class=\"token operator\">&lt;</span> databases/tracker/create_databases.sql</code></pre></div>","position":{"start":{"line":135,"column":1,"offset":3800},"end":{"line":137,"column":4,"offset":3865}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Add the ","position":{"start":{"line":139,"column":1,"offset":3867},"end":{"line":139,"column":9,"offset":3875}}},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"time_entries","position":{"start":{"line":139,"column":11,"offset":3877},"end":{"line":139,"column":23,"offset":3889}}}],"position":{"start":{"line":139,"column":9,"offset":3875},"end":{"line":139,"column":25,"offset":3891}}},{"type":"text","value":" table to both databases using the Flyway CLI:","position":{"start":{"line":139,"column":25,"offset":3891},"end":{"line":139,"column":71,"offset":3937}}}],"position":{"start":{"line":139,"column":1,"offset":3867},"end":{"line":139,"column":71,"offset":3937}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">flyway -url<span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://localhost:3306/tracker_dev\"</span> -locations<span class=\"token operator\">=</span>filesystem:databases/tracker clean migrate\nflyway -url<span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://localhost:3306/tracker_test\"</span> -locations<span class=\"token operator\">=</span>filesystem:databases/tracker clean migrate</code></pre></div>","position":{"start":{"line":141,"column":1,"offset":3939},"end":{"line":144,"column":4,"offset":4167}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The databases can now be inspected with MySQL.","position":{"start":{"line":146,"column":1,"offset":4169},"end":{"line":146,"column":47,"offset":4215}}}],"position":{"start":{"line":146,"column":1,"offset":4169},"end":{"line":146,"column":47,"offset":4215}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Open MySQL on the CLI:","position":{"start":{"line":148,"column":1,"offset":4217},"end":{"line":148,"column":23,"offset":4239}}}],"position":{"start":{"line":148,"column":1,"offset":4217},"end":{"line":148,"column":23,"offset":4239}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql -u tracker</code></pre></div>","position":{"start":{"line":150,"column":1,"offset":4241},"end":{"line":152,"column":4,"offset":4269}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Inspect the database:","position":{"start":{"line":154,"column":1,"offset":4271},"end":{"line":154,"column":22,"offset":4292}}}],"position":{"start":{"line":154,"column":1,"offset":4271},"end":{"line":154,"column":22,"offset":4292}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">use</span> tracker_dev<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">describe</span> time_entries<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span><span class=\"token comment\">------------+--------------+------+-----+---------+----------------+</span>\n<span class=\"token operator\">|</span> Field      <span class=\"token operator\">|</span> <span class=\"token keyword\">Type</span>         <span class=\"token operator\">|</span> <span class=\"token boolean\">Null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Key</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Default</span> <span class=\"token operator\">|</span> Extra          <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------+--------------+------+-----+---------+----------------+</span>\n<span class=\"token operator\">|</span> id         <span class=\"token operator\">|</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span> PRI <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span> <span class=\"token keyword\">auto_increment</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> project_id <span class=\"token operator\">|</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> user_id    <span class=\"token operator\">|</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>         <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> hours      <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span>      <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------+--------------+------+-----+---------+----------------+</span></code></pre></div>","position":{"start":{"line":156,"column":1,"offset":4294},"end":{"line":169,"column":4,"offset":4975}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Your local databases are ready to go!","position":{"start":{"line":171,"column":1,"offset":4977},"end":{"line":171,"column":38,"offset":5014}}}],"position":{"start":{"line":171,"column":1,"offset":4977},"end":{"line":171,"column":38,"offset":5014}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"4. Create and Migrate the Database on Cloud Foundry","position":{"start":{"line":173,"column":4,"offset":5019},"end":{"line":173,"column":55,"offset":5070}}}],"position":{"start":{"line":173,"column":1,"offset":5016},"end":{"line":173,"column":55,"offset":5070}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The database provided by Cloud Foundry is behind a Firewall, so it's necessary to open an SSH tunnel. The following is a fully re-usable script for running the migration as part of a CI process:","position":{"start":{"line":175,"column":1,"offset":5072},"end":{"line":175,"column":195,"offset":5266}}}],"position":{"start":{"line":175,"column":1,"offset":5072},"end":{"line":175,"column":195,"offset":5266}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token comment\"># Fail on error</span>\n<span class=\"token builtin class-name\">set</span> -e\n\n<span class=\"token comment\"># Get the GUID of the app - pass pal-tracker as first arg to script</span>\n<span class=\"token assign-left variable\">app_guid</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>cf app $1 --guid<span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">credentials</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>cf <span class=\"token function\">curl</span> /v2/apps/$app_guid/env <span class=\"token operator\">|</span> jq <span class=\"token string\">'.system_env_json.VCAP_SERVICES | .[] | .[] | select(.instance_name==\"pal-tracker-db\") | .credentials'</span><span class=\"token variable\">`</span></span>\n\n<span class=\"token comment\"># Get MySQL Connection info</span>\n<span class=\"token assign-left variable\">ip_address</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.hostname'</span><span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">db_name</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.name'</span><span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">db_username</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.username'</span><span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">db_password</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.password'</span><span class=\"token variable\">`</span></span>\n\n<span class=\"token comment\"># Open SSH tunnel</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Opening ssh tunnel to <span class=\"token variable\">$ip_address</span>\"</span>\ncf <span class=\"token function\">ssh</span> -N -L <span class=\"token number\">63306</span>:<span class=\"token variable\">$ip_address</span>:3306 pal-tracker <span class=\"token operator\">&amp;</span>\n<span class=\"token assign-left variable\">cf_ssh_pid</span><span class=\"token operator\">=</span><span class=\"token variable\">$!</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Waiting for tunnel\"</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">5</span>\n\n<span class=\"token comment\"># Run migrations</span>\nflyway-*/flyway -url<span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://127.0.0.1:63306/<span class=\"token variable\">$db_name</span>\"</span> -locations<span class=\"token operator\">=</span>filesystem:<span class=\"token variable\">$2</span>/databases/tracker -user<span class=\"token operator\">=</span><span class=\"token variable\">$db_username</span> -password<span class=\"token operator\">=</span><span class=\"token variable\">$db_password</span> migrate\n\n<span class=\"token function\">kill</span> -STOP <span class=\"token variable\">$cf_ssh_pid</span></code></pre></div>","position":{"start":{"line":177,"column":1,"offset":5268},"end":{"line":205,"column":4,"offset":6156}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To run the script, pass the application name and root directory to the script:","position":{"start":{"line":207,"column":1,"offset":6158},"end":{"line":207,"column":79,"offset":6236}}}],"position":{"start":{"line":207,"column":1,"offset":6158},"end":{"line":207,"column":79,"offset":6236}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./scripts/migrate-databases.sh pal-tracker <span class=\"token builtin class-name\">.</span></code></pre></div>","position":{"start":{"line":209,"column":1,"offset":6238},"end":{"line":211,"column":4,"offset":6294}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Once the script has completed, the Cloud Foundry database is ready to go!","position":{"start":{"line":213,"column":1,"offset":6296},"end":{"line":213,"column":74,"offset":6369}}}],"position":{"start":{"line":213,"column":1,"offset":6296},"end":{"line":213,"column":74,"offset":6369}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":213,"column":74,"offset":6369}}}}