<!DOCTYPE html>
<html lang="en-us">
    <head>
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-961598-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-961598-2');
</script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Database as Code on Cloud Foundry with Flyway</title>
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: red;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c#.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/css.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/http.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/ruby.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/groovy.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/json.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/markdown.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/powershell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/typescript.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.54.0" />
        
        
        
    </head>

    <body>
         
        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Database as Code on Cloud Foundry with Flyway</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/languages/">Languages</a></li>
                            
                                <li><a href="/tools/">Tools</a></li>
                            
                                <li><a href="/techniques/">Techniques</a></li>
                            
                                <li><a href="/hire-me/">Hire Me</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:jimmy.tharpe@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/jamestharpe/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://twitter.com/jamestharpe/"><i class="fa fa-twitter"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/jamestharpe/"><i class="fa fa-linkedin"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://stackoverflow.com/users/104763/james"><i class="fa fa-stack-overflow"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/database-as-code-flyway/">Database as Code on Cloud Foundry with Flyway</a></h4>
    <h5>January 15, 2019</h5>
    

</div>


    <br> <div class="text-justify">

<h1 id="database-migrations-on-cloud-foundry-with-flyway">Database Migrations on Cloud Foundry with Flyway</h1>

<p>I took the <a href="https://courses.education.pivotal.io/c/349802825/">PCF Cloud Native Developer four day course</a> to prepare for the <a href="https://pivotal.io/training/certification/pivotal-developer-certification">Pivotal Certified Java Developer</a> exam. This was my first in-depth exposure to PCF and Spring (Boot, MVC, Cloud), so there was a lot to learn with little experience. I learned a lot and enjoyed the course.</p>

<p>In my last article, I shared my notes on <a href="https://www.jamestharpe.com/spring-mvc-crud-operations/">Spring MVC CRUD operations</a>. This article will cover database migrations using <a href="https://flywaydb.org/">Flyway</a> and MySQL, deploying to Cloud Foundry.</p>

<h2 id="provision-and-bind-mysql-in-cloud-foundry">Provision and Bind MySQL in Cloud Foundry</h2>

<p>Use <code>cf marketplace</code> to find the appropriate service and provisioning options for MySQL, then use <code>cf create-service</code> to provision the service:</p>

<pre><code class="language-bash">$ cf marketplace
Getting services from marketplace in org some-org / space develop as you@example.com...
OK

service               plans                  description
# ...
p-mysql               100mb, 1gb             A DBaaS
# ...
</code></pre>

<p>In the example above, the <code>p-mysql</code> service is avaialbe. Provision it with <code>cf create-service</code>:</p>

<pre><code class="language-bash">cf create-service p-mysql 100mb pal-tracker-db
</code></pre>

<p>The <code>cf create-service</code> call will return immedietly, before the service is provisioned. To check the status use <code>cf service</code>:</p>

<pre><code class="language-bash">$ cf service pal-tracker-db

Service instance: pal-tracker-db
Service: p-mysql
Plan: 100mb
Description: MySQL databases on demand
Documentation url:
Dashboard: https://p-mysql.example.com/manage/instances/abcd-ef12-3456

Last Operation
Status: create succeeded
Message:
Started: 2019-01-15T22:59:07Z
Updated: 2019-01-15T22:59:26Z
</code></pre>

<p>Once the service is ready, bind it to the <strong>pal-tracker</strong> application:</p>

<pre><code class="language-bash">cf bind-service pal-tracker pal-tracker-db # Service info added to VCAP_SERVICES env var
</code></pre>

<p>Once the service is bound, the <strong>VCAP_SERVICES</strong> environment variable will contain details about the service:</p>

<pre><code class="language-bash">$ cf env my-app
Getting env variables for app pal-tracker in org some-org / space some-space as
you...
OK
System-Provided:

{
    &quot;VCAP_SERVICES&quot;: {
        &quot;p.mysql&quot;: [{
            &quot;label&quot;: &quot;p.mysql&quot;,
            &quot;name&quot;: &quot;pal-tracker-db&quot;,
            &quot;plan&quot;: &quot;db-small&quot;,
            &quot;provider&quot;: null,
            &quot;syslog_drain_url&quot;: null,
            &quot;tags&quot;: [ &quot;mysql&quot; ],
            &quot;credentials&quot;: {
            &quot;hostname&quot;: &quot;10.0.0.20&quot;,
            &quot;jdbcUrl&quot;: &quot;jdbc:mysql://10.0.0.20:3306/service_instance_db?user=fefcbe8360854a18a7994b870e7b0bf5\u0026password=z9z6eskdbs1rhtxt&quot;,
            &quot;name&quot;: &quot;service_instance_db&quot;,
            &quot;password&quot;: &quot;z9z6eskdbs1rhtxt&quot;,
            &quot;port&quot;: 3306,
            &quot;uri&quot;: &quot;mysql://fefcbe8360854a18a7994b870e7b0bf5:z9z6eskdbs1rhtxt@10.0.0.20:3306/service_instance_db?reconnect=true&quot;,
            &quot;username&quot;: &quot;fefcbe8360854a18a7994b870e7b0bf5&quot;
            },
            &quot;volume_mounts&quot;: []
        }
    }
    ...
}
</code></pre>

<h2 id="add-the-database-as-code-to-the-project">Add the Database &ldquo;as code&rdquo; to the Project</h2>

<p>Continuing with the <a href="/projects/pal-tracker">PAL Tracker</a> application, create a <strong>databases/tracker</strong> folder in the application root then create a file called <strong>create_databases.sql</strong> there:</p>

<pre><code class="language-bash">mkdir -p database/tracker
touch database/tracker/create_databases.sql
</code></pre>

<p>Edit the <strong>create_databases.sql</strong> file to create <strong>tracker_dev</strong> and <strong>tracker_test</strong> databases:</p>

<pre><code class="language-sql">-- Delete DBs if they exist
DROP DATABASE IF EXISTS tracker_dev;
DROP DATABASE IF EXISTS tracker_test;

-- Create the databases
CREATE DATABASE tracker_dev;
CREATE DATABASE tracker_test;

-- Add a user with full access to both DBs
CREATE USER IF NOT EXISTS 'tracker'@'localhost'
  IDENTIFIED BY '';
GRANT ALL PRIVILEGES ON tracker_dev.* TO 'tracker' @'localhost';
GRANT ALL PRIVILEGES ON tracker_test.* TO 'tracker' @'localhost';
</code></pre>

<h3 id="add-the-first-migration">Add the first Migration</h3>

<p>Add a file called <code>V1__initial_schema.sql</code> to a folder called <strong>migrations</strong> in the <strong>database/tracker</strong> folder, then add a <code>CREATE TABLE</code> statement to store <code>TimeEntry</code> objects created in the <a href="https://www.jamestharpe.com/spring-mvc-crud-operations/">Spring MVC CRUD operations</a> article:</p>

<pre><code class="language-sql">CREATE TABLE time_entries (
  id         BIGINT(20) NOT NULL AUTO_INCREMENT,
  project_id BIGINT(20), -- projectId on TimeEntry
  user_id    BIGINT(20), -- userId on TimeEntry
  date       DATE,
  hours      INT,

  PRIMARY KEY (id)
)
  ENGINE = innodb
  DEFAULT CHARSET = utf8;
</code></pre>

<h2 id="create-and-migrate-a-local-mysql-databases">Create and Migrate a Local MySQL Databases</h2>

<p>To create the test and development databases, simply pass the <strong>create_databases.sql</strong> file to MySQL on the command line:</p>

<pre><code class="language-bash">mysql -uroot &lt; databases/tracker/create_databases.sql
</code></pre>

<p>Add the <strong>time_entries</strong> table to both databases using the Flyway CLI:</p>

<pre><code class="language-bash">flyway -url=&quot;jdbc:mysql://localhost:3306/tracker_dev&quot; -locations=filesystem:databases/tracker clean migrate
flyway -url=&quot;jdbc:mysql://localhost:3306/tracker_test&quot; -locations=filesystem:databases/tracker clean migrate
</code></pre>

<p>The databases can now be inspected with MySQL.</p>

<p>Open MySQL on the CLI:</p>

<pre><code class="language-bash">mysql -u tracker
</code></pre>

<p>Inspect the database:</p>

<pre><code class="language-sql">use tracker_dev;
describe time_entries;

+------------+--------------+------+-----+---------+----------------+
| Field      | Type         | Null | Key | Default | Extra          |
+------------+--------------+------+-----+---------+----------------+
| id         | bigint(20)   | NO   | PRI | NULL    | auto_increment |
| project_id | bigint(20)   | YES  |     | NULL    |                |
| user_id    | bigint(20)   | YES  |     | NULL    |                |
| date       | date         | YES  |     | NULL    |                |
| hours      | int(11)      | YES  |     | NULL    |                |
+------------+--------------+------+-----+---------+----------------+
</code></pre>

<p>Your local databases are ready to go!</p>

<h2 id="create-and-migrate-the-database-on-cloud-foundry">Create and Migrate the Database on Cloud Foundry</h2>

<p>The database provided by Cloud Foundry is behind a Firewall, so it&rsquo;s necessary to open an SSH tunnel. The following is a fully re-usable script for running the migration as part of a CI process:</p>

<pre><code class="language-bash">#!/usr/bin/env bash

# Fail on error
set -e

# Get the GUID of the app - pass pal-tracker as first arg to script
app_guid=`cf app $1 --guid`
credentials=`cf curl /v2/apps/$app_guid/env | jq '.system_env_json.VCAP_SERVICES | .[] | .[] | select(.instance_name==&quot;pal-tracker-db&quot;) | .credentials'`

# Get MySQL Connection info
ip_address=`echo $credentials | jq -r '.hostname'`
db_name=`echo $credentials | jq -r '.name'`
db_username=`echo $credentials | jq -r '.username'`
db_password=`echo $credentials | jq -r '.password'`

# Open SSH tunnel
echo &quot;Opening ssh tunnel to $ip_address&quot;
cf ssh -N -L 63306:$ip_address:3306 pal-tracker &amp;
cf_ssh_pid=$!

echo &quot;Waiting for tunnel&quot;
sleep 5

# Run migrations
flyway-*/flyway -url=&quot;jdbc:mysql://127.0.0.1:63306/$db_name&quot; -locations=filesystem:$2/databases/tracker -user=$db_username -password=$db_password migrate

kill -STOP $cf_ssh_pid
</code></pre>

<p>To run the script, pass the application name and root directory to the script:</p>

<pre><code class="language-bash">./scripts/migrate-databases.sh pal-tracker .
</code></pre>

<p>Once the script has completed, the Cloud Foundry database is ready to go!</p>
</div>

    
    

    

    

</main>

        <footer>

            <p class="copyright text-muted">Copyright &copy; James Tharpe; All rights reserved.</p>

        </footer>
       
    </body>

</html>

