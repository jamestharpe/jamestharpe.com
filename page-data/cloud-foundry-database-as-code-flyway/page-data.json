{"componentChunkName":"component---src-templates-article-tsx","path":"/cloud-foundry-database-as-code-flyway/","result":{"data":{"markdownRemark":{"html":"<h1>Recipe: Database as Code with Flyway &#x26; MySQL on Cloud Foundry</h1>\n<p>This recipe is illustrated in the <a href=\"../pal-tracker/\">PAL Tracker</a> example project.</p>\n<h2>1. Provision and Bind MySQL in Cloud Foundry</h2>\n<p>Use <code class=\"language-text\">cf marketplace</code> to find the appropriate service and provisioning options for MySQL, then use <code class=\"language-text\">cf create-service</code> to provision the service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cf marketplace\nGetting services from marketplace <span class=\"token keyword\">in</span> org some-org / space develop as you@example.com<span class=\"token punctuation\">..</span>.\nOK\n\n<span class=\"token function\">service</span>               plans                  description\n<span class=\"token comment\"># ...</span>\np-mysql               100mb, 1gb             A DBaaS\n<span class=\"token comment\"># ...</span></code></pre></div>\n<p>In the example above, the <code class=\"language-text\">p-mysql</code> service is available. Provision it with <code class=\"language-text\">cf create-service</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf create-service p-mysql 100mb pal-tracker-db</code></pre></div>\n<p>The <code class=\"language-text\">cf create-service</code> call will return immediately, before the service is provisioned. To check the status use <code class=\"language-text\">cf service</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cf <span class=\"token function\">service</span> pal-tracker-db\n\nService instance: pal-tracker-db\nService: p-mysql\nPlan: 100mb\nDescription: MySQL databases on demand\nDocumentation url:\nDashboard: https://p-mysql.example.com/manage/instances/abcd-ef12-3456\n\nLast Operation\nStatus: create succeeded\nMessage:\nStarted: <span class=\"token number\">2019</span>-01-15T22:59:07Z\nUpdated: <span class=\"token number\">2019</span>-01-15T22:59:26Z</code></pre></div>\n<p>Once the service is ready, bind it to the <strong>pal-tracker</strong> application:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf bind-service pal-tracker pal-tracker-db <span class=\"token comment\"># Service info added to VCAP_SERVICES env var</span></code></pre></div>\n<p>Once the service is bound, the <strong>VCAP_SERVICES</strong> environment variable will contain details about the service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cf <span class=\"token function\">env</span> my-app\nGetting <span class=\"token function\">env</span> variables <span class=\"token keyword\">for</span> app pal-tracker <span class=\"token keyword\">in</span> org some-org / space some-space as\nyou<span class=\"token punctuation\">..</span>.\nOK\nSystem-Provided:\n\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token string\">\"VCAP_SERVICES\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token string\">\"p.mysql\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token string\">\"label\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"p.mysql\"</span>,\n\t\t\t<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"pal-tracker-db\"</span>,\n\t\t\t<span class=\"token string\">\"plan\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"db-small\"</span>,\n\t\t\t<span class=\"token string\">\"provider\"</span><span class=\"token builtin class-name\">:</span> null,\n\t\t\t<span class=\"token string\">\"syslog_drain_url\"</span><span class=\"token builtin class-name\">:</span> null,\n\t\t\t<span class=\"token string\">\"tags\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mysql\"</span> <span class=\"token punctuation\">]</span>,\n\t\t\t<span class=\"token string\">\"credentials\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token string\">\"hostname\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"10.0.0.20\"</span>,\n\t\t\t<span class=\"token string\">\"jdbcUrl\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"jdbc:mysql://10.0.0.20:3306/service_instance_db?user=fefcbe8360854a18a7994b870e7b0bf5<span class=\"token entity\" title=\"\\u0026\">\\u0026</span>password=z9z6eskdbs1rhtxt\"</span>,\n\t\t\t<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"service_instance_db\"</span>,\n\t\t\t<span class=\"token string\">\"password\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"z9z6eskdbs1rhtxt\"</span>,\n\t\t\t<span class=\"token string\">\"port\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token number\">3306</span>,\n\t\t\t<span class=\"token string\">\"uri\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"mysql://fefcbe8360854a18a7994b870e7b0bf5:z9z6eskdbs1rhtxt@10.0.0.20:3306/service_instance_db?reconnect=true\"</span>,\n\t\t\t<span class=\"token string\">\"username\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"fefcbe8360854a18a7994b870e7b0bf5\"</span>\n\t\t\t<span class=\"token punctuation\">}</span>,\n\t\t\t<span class=\"token string\">\"volume_mounts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">..</span>.\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>2. Add the Database \"as code\" to the Project</h2>\n<p>Create a <strong>databases/tracker</strong> folder in the application root then create a file called <strong>create_databases.sql</strong> there:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> -p database/tracker\n<span class=\"token function\">touch</span> database/tracker/create_databases.sql</code></pre></div>\n<p>Edit the <strong>create_databases.sql</strong> file to create <strong>tracker_dev</strong> and <strong>tracker_test</strong> databases:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Delete DBs if they exist</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">DATABASE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> tracker_dev<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">DATABASE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> tracker_test<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Create the databases</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> tracker_dev<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> tracker_test<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Add a user with full access to both DBs</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> <span class=\"token string\">'tracker'</span><span class=\"token variable\">@'localhost'</span>\n  IDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token keyword\">ON</span> tracker_dev<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'tracker'</span> <span class=\"token variable\">@'localhost'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token keyword\">ON</span> tracker_test<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">TO</span> <span class=\"token string\">'tracker'</span> <span class=\"token variable\">@'localhost'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Add the first Migration</h3>\n<p>Add a file called <code class=\"language-text\">V1__initial_schema.sql</code> to a folder called <strong>migrations</strong> in the <strong>database/tracker</strong> folder, then add a <code class=\"language-text\">CREATE TABLE</code> statement to store <code class=\"language-text\">TimeEntry</code> objects.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> time_entries <span class=\"token punctuation\">(</span>\n  id         <span class=\"token keyword\">BIGINT</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  project_id <span class=\"token keyword\">BIGINT</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- projectId on TimeEntry</span>\n  user_id    <span class=\"token keyword\">BIGINT</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">-- userId on TimeEntry</span>\n  <span class=\"token keyword\">date</span>       <span class=\"token keyword\">DATE</span><span class=\"token punctuation\">,</span>\n  hours      <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">ENGINE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">innodb</span>\n  <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span> <span class=\"token operator\">=</span> utf8<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>3. Create and Migrate a Local MySQL Databases</h2>\n<p>To create the test and development databases, simply pass the <strong>create_databases.sql</strong> file to MySQL on the command line:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql -uroot <span class=\"token operator\">&lt;</span> databases/tracker/create_databases.sql</code></pre></div>\n<p>Add the <strong>time_entries</strong> table to both databases using the Flyway CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">flyway -url<span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://localhost:3306/tracker_dev\"</span> -locations<span class=\"token operator\">=</span>filesystem:databases/tracker clean migrate\nflyway -url<span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://localhost:3306/tracker_test\"</span> -locations<span class=\"token operator\">=</span>filesystem:databases/tracker clean migrate</code></pre></div>\n<p>The databases can now be inspected with MySQL.</p>\n<p>Open MySQL on the CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mysql -u tracker</code></pre></div>\n<p>Inspect the database:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">use</span> tracker_dev<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">describe</span> time_entries<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span><span class=\"token comment\">------------+--------------+------+-----+---------+----------------+</span>\n<span class=\"token operator\">|</span> Field      <span class=\"token operator\">|</span> <span class=\"token keyword\">Type</span>         <span class=\"token operator\">|</span> <span class=\"token boolean\">Null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Key</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Default</span> <span class=\"token operator\">|</span> Extra          <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------+--------------+------+-----+---------+----------------+</span>\n<span class=\"token operator\">|</span> id         <span class=\"token operator\">|</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">|</span> <span class=\"token keyword\">NO</span>   <span class=\"token operator\">|</span> PRI <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span> <span class=\"token keyword\">auto_increment</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> project_id <span class=\"token operator\">|</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> user_id    <span class=\"token operator\">|</span> <span class=\"token keyword\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>         <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> hours      <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span>      <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span>     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------+--------------+------+-----+---------+----------------+</span></code></pre></div>\n<p>Your local databases are ready to go!</p>\n<h2>4. Create and Migrate the Database on Cloud Foundry</h2>\n<p>The database provided by Cloud Foundry is behind a Firewall, so it's necessary to open an SSH tunnel. The following is a fully re-usable script for running the migration as part of a CI process:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token comment\"># Fail on error</span>\n<span class=\"token builtin class-name\">set</span> -e\n\n<span class=\"token comment\"># Get the GUID of the app - pass pal-tracker as first arg to script</span>\n<span class=\"token assign-left variable\">app_guid</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>cf app $1 --guid<span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">credentials</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>cf <span class=\"token function\">curl</span> /v2/apps/$app_guid/env <span class=\"token operator\">|</span> jq <span class=\"token string\">'.system_env_json.VCAP_SERVICES | .[] | .[] | select(.instance_name==\"pal-tracker-db\") | .credentials'</span><span class=\"token variable\">`</span></span>\n\n<span class=\"token comment\"># Get MySQL Connection info</span>\n<span class=\"token assign-left variable\">ip_address</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.hostname'</span><span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">db_name</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.name'</span><span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">db_username</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.username'</span><span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">db_password</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $credentials <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.password'</span><span class=\"token variable\">`</span></span>\n\n<span class=\"token comment\"># Open SSH tunnel</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Opening ssh tunnel to <span class=\"token variable\">$ip_address</span>\"</span>\ncf <span class=\"token function\">ssh</span> -N -L <span class=\"token number\">63306</span>:<span class=\"token variable\">$ip_address</span>:3306 pal-tracker <span class=\"token operator\">&amp;</span>\n<span class=\"token assign-left variable\">cf_ssh_pid</span><span class=\"token operator\">=</span><span class=\"token variable\">$!</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Waiting for tunnel\"</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">5</span>\n\n<span class=\"token comment\"># Run migrations</span>\nflyway-*/flyway -url<span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://127.0.0.1:63306/<span class=\"token variable\">$db_name</span>\"</span> -locations<span class=\"token operator\">=</span>filesystem:<span class=\"token variable\">$2</span>/databases/tracker -user<span class=\"token operator\">=</span><span class=\"token variable\">$db_username</span> -password<span class=\"token operator\">=</span><span class=\"token variable\">$db_password</span> migrate\n\n<span class=\"token function\">kill</span> -STOP <span class=\"token variable\">$cf_ssh_pid</span></code></pre></div>\n<p>To run the script, pass the application name and root directory to the script:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./scripts/migrate-databases.sh pal-tracker <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>Once the script has completed, the Cloud Foundry database is ready to go!</p>","fields":{"slug":"/cloud-foundry-database-as-code-flyway/"},"frontmatter":{"title":"Database as Code: Flyway & MySQL on Cloud Foundry","tags":["cloud-foundry","database-as-code","flyway","mysql","pal-tracker"]}}},"pageContext":{"slug":"/cloud-foundry-database-as-code-flyway/"}},"staticQueryHashes":["2270328656","3794076007","80858887"]}