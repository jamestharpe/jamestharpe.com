{"componentChunkName":"component---src-templates-article-tsx","path":"/cloud-foundry-spring-boot-environment/","result":{"data":{"markdownRemark":{"html":"<h1>Recipe: Configure Spring Boot on Cloud Foundry</h1>\n<p>This recipe is illustrated in the <a href=\"../pal-tracker/\">PAL Tracker</a> example project.</p>\n<h2>1. Inject Environment Variables into a Controller</h2>\n<p>Update the <code class=\"language-text\">WelcomeController</code> so that the <code class=\"language-text\">sayHello()</code> method returns a <code class=\"language-text\">message</code> field set by the constructor. Use the <code class=\"language-text\">@Value</code> annotation to inject the value from the environment:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>pivotal<span class=\"token punctuation\">.</span>pal<span class=\"token punctuation\">.</span>tracker</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Value</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">GetMapping</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">RestController</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WelcomeController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> message<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">WelcomeController</span><span class=\"token punctuation\">(</span>\n        <span class=\"token comment\">// Injects the WELCOME_MESSAGE environment variable</span>\n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${welcome.message}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> message\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> message<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> message<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Running the app now will result in a failure: <code class=\"language-text\">Could not resolve placeholder &#39;welcome.message&#39; in value &quot;${welcome.message}&quot;</code>.</p>\n<p>To resolve this, update the <strong>build.gradle</strong> to set the <code class=\"language-text\">WELCOME_MESSAGE</code> environment variable in the <code class=\"language-text\">bootRun</code> configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">bootRun<span class=\"token punctuation\">.</span><span class=\"token function\">environment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n     <span class=\"token string gstring\">\"WELCOME_MESSAGE\"</span><span class=\"token punctuation\">:</span> <span class=\"token string gstring\">\"hello\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>2. Built-in Cloud Foundry Environment Variables</h2>\n<p>Cloud Foundry comes with several <a href=\"https://docs.run.pivotal.io/devguide/deploy-apps/environment-variable.html\">built-in environment variables</a> accessible to your application. To show this, let's create a new controller called <code class=\"language-text\">EnvController</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>pivotal<span class=\"token punctuation\">.</span>pal<span class=\"token punctuation\">.</span>tracker</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Value</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">GetMapping</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">RestController</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EnvController</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> port<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> memoryLimit<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> cfInstanceIndex<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> cfInstanceAddress<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">EnvController</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token comment\">// Injects the PORT environment variable, defaults to NOT SET</span>\n\t\t<span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${port:NOT SET}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> port<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token comment\">// Injects the MEMORY_LIMIT environment variable, defaults to NOT SET</span>\n\t\t<span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${memory.limit:NOT SET}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> memoryLimit<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token comment\">// Injects the CF_INSTANCE_INDEX environment variable, defaults to NOT SET</span>\n\t\t<span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cf.instance.index:NOT SET}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> cfInstanceIndex<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token comment\">// Injects the CF_INSTANCE_ADDR environment variable, defaults to NOT SET</span>\n\t\t<span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${cf.instance.addr:NOT SET}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> cfInstanceAddress\n\t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> port<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memoryLimit <span class=\"token operator\">=</span> memoryLimit<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>cfInstanceIndex <span class=\"token operator\">=</span> cfInstanceIndex<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>cfInstanceAddress <span class=\"token operator\">=</span> cfInstanceAddress<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Maps GET requests to /env</span>\n\t<span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/env\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tresult<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PORT\"</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tresult<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MEMORY_LIMIT\"</span><span class=\"token punctuation\">,</span> memoryLimit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tresult<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CF_INSTANCE_INDEX\"</span><span class=\"token punctuation\">,</span> cfInstanceIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tresult<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CF_INSTANCE_ADDR\"</span><span class=\"token punctuation\">,</span> cfInstanceAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Run the app and visit the <code class=\"language-text\">/env</code> end-point to see the output in your local environment:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n\t<span class=\"token property\">\"PORT\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NOT SET\"</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token property\">\"CF_INSTANCE_ADDR\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NOT SET\"</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token property\">\"CF_INSTANCE_INDEX\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NOT SET\"</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token property\">\"MEMORY_LIMIT\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NOT SET\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Set Environment Variables in Cloud Foundry</h3>\n<p>Deploy the app to see what happens in production:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf push -p build/libs/pal-tracker.jar</code></pre></div>\n<p>The app will crash because the <code class=\"language-text\">WELCOME_MESSAGE</code> environment variable isn't set. The environment variable can be set using <code class=\"language-text\">cf set-env</code> then restaging:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf set-env pal-tracker WELCOME_MESSAGE hi\ncf restage pal-tracker <span class=\"token comment\"># no need to re-push</span></code></pre></div>\n<p>Now when you check the Cloud Foundry endpoint, it will have the actual values:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"PORT\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"80\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CF_INSTANCE_ADDR\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.2.3.4:80\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CF_INSTANCE_INDEX\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"MEMORY_LIMIT\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1GB\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>3. Scale your Cloud Foundry App</h2>\n<p>Scaling can be done horizontally, vertically, or both using the <code class=\"language-text\">cf scale</code> command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Scale to 3 instances, 2GB storage, 1024M memory and force a restart</span>\ncf scale APP -i <span class=\"token number\">3</span> -k 2G -m 1024M -f</code></pre></div>\n<p>Check on the process by running <code class=\"language-text\">cf app pal-tracker</code>.</p>\n<h2>4. Use a Manifest File</h2>\n<p>The <a href=\"https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html\">manifest.yml</a> specified an application's environment defaults, so they only need to be managed with the CLI if they need to be overridden. Rather than setting the <code class=\"language-text\">WELCOME_MESSAGE</code> value using <code class=\"language-text\">cf set-env</code>, the value can be specified in the <strong>manifest.yml</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">applications</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pal<span class=\"token punctuation\">-</span>tracker\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> build/libs/pal<span class=\"token punctuation\">-</span>tracker.jar\n  <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">WELCOME_MESSAGE</span><span class=\"token punctuation\">:</span> Hello from the Manifest</code></pre></div>\n<p>Run <code class=\"language-text\">cf push</code> again to see the updated <code class=\"language-text\">WELCOME_MESSAGE</code> value in the CF environment.</p>","fields":{"slug":"/cloud-foundry-spring-boot-environment/"},"frontmatter":{"title":"Cloud Foundry Spring Boot Environment Basics","tags":["cloud-foundry","gradle","intellij","java","microservices","pal-tracker"]}}},"pageContext":{"slug":"/cloud-foundry-spring-boot-environment/"}},"staticQueryHashes":["2270328656","3794076007","80858887"]}